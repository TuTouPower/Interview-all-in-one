# 传输层

## 为什么需要传输层

> 物理层用网线光缆不需要地址。数据链路层（以太网协议）电脑多了需要MAC地址。IP层电脑更多了需要IP地址。IP地址能找到主机，还需要传输层还找到主机上某个进程（端口）。**多路复用与多路分解**

### 传输层的作用

网络层提供了**主机之间**的逻辑通信，而传输层为运行在不同主机上的**进程之间**提供了逻辑通信。  

UDP 和 TCP 最基本的责任是，将两个端系统间 的交付服务扩展为运行在端系统上的两个进程之间的交付服务 。 将主机间交付扩展到进程间交付被称为传输层的多路复用( transport- layer multiplexing ）与多路分解（demultiplexing)

IP 的服务模型是**尽力而为交付服务**（ best- effort delivery service ） 。这意味着 IP 尽它“最大的努力”在通信的主机之间交忖报文段，但它并不做任何确保 。特别是，它不确保报文段的交付 ， 不保证报文段的按序交付，不保证报文段巾数据的完整性。 由于这些原因，IP被称为**不可靠服务**（ unreliable service ）

传输协议能够提供的服务常常受制于底层网络层协议的服务模型 。 如果网络层协议无法为主机之间发送的传输层报文段提供时延或带宽保证的话，传输层协议也就无法为进程之间发送的应用程序报文提供时延或带宽保证。

然而，即使底层网络协议不能在网络层提供相应的服务，传输层协议也能提供某些服务 。 例如，如我们将在本章所见，即使底层网络协议是不可靠的，也就是说网络层协议会使分组丢失、篡改和冗余，传输协议也能为应用程序提供可靠的数据传输服务 。 另一个例子是（我们在第 8 章讨论网络安全时将会研究到），即使网络层不能保证传输层报文段的机密性，传输协议也能使用加密来确保应用程序报文不被人侵者读取

###  多路复用与多路分解

现在我们考虑接收主机怎样将一个到达的传输层报文段定向到适当的套接字 。 为此目的，每个传输层报文段中具有几个字段。 在接收端，传输层检查这些字段，标识出接收套接字，进而将报文段定向到该套接字 。 将传输层报文段中的数据交付到正确的套接字的工作称为**多路分解**。 在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息（这将在以后用于分解）从而生成报文段，然后将报文段传递到网络层，所有这些工作称为**多路复用**。

## 无连接传输：UDP

### UDP特点

+ **关于何时、发送什么数据的应用层控制更为精细** 。 采用 UDP 时，只要应用进程将数据传递给 UDP, UDP 就会将此数据打包进 UDP 报文段并立即将其传递给网络层 。 在另一方面， TCP 有一个拥塞控制机制，以便当源和目的主机间的一条或多条链路变得极度拥塞时来遏制传输层 TCP 发送方 。 TCP 仍将继续重新发送数据报文段直到目的主机收到此报文并加以确认，而不管可靠交付需要用多段时间 。 因为实时应用通常要求最小的发送速率，不希望过分地延迟报文段的传送，且能容忍一些数据丢失， TCP 服务模型并不是特别适合这些应用的需要 。 如后面所讨论的，这些应用可以使用 UDP ，作为应用的一部分来实现所需的、超出 UDP 的不提供不必要的报文段交付服务之外的功能 。

+ **无需连接建立**。如我们后面所讨论的， TCP 在开始数据传输之前要经过三次握手 。UDP 却不需要任何准备即可进行数据传输 。 因此 UDP 不会引人建立连接的时延 。这可能是 DNS 运行在 UDP 之上而不是运行在 TCP 之上的主要原因（如果运行在TCP 上，则 DNS 会慢得多） 。 HTTP 使用 TCP 而不是 UDP ，因为对于具有文本数据的 Web 网贞来说，可靠性是至关重要的 。但是，如我们在 2.2 节中简要讨论的那样， HTTP 中的 TCP 连接建立时延对于与下载 Web 文档相关的时延来说是一个重要因素 。

+ **无连接状态** 。 TCP 需要在端系统中维护连接状态。 此连接状态包括接收和发送缓存、拥塞控制参数以及序号与确认号的参数。 要实现 TCP的可靠数据传输服务并提供拥塞控制，这些状态信息是必要的 。 在另一方面，UDP 不维护连接状态，也不跟踪这些参数 。 因此，某些专门用于某种特定应用的服务器当应用程序运行在 UDP 之上而不是运行在 TCP 上时，一般都能支持更多的活跃客户 。
+ **分组首部开销小** 。 每个 TCP 报文段都有 20 字节的首部开销，而 UDP 仅有 8 字节的开销 。
+ **使用 UDP 的应用是可以实现可靠数据传输的**。 这可通过在应用程序自身建立可靠性机制来完成（例如，可通过增加确认与重传机制来实现，如采用我们将在下一节学习的一些机制） 。 但这并不是无足轻重的任务，它会使应用开发人员长时间地忙于调试。 无论如何，将可靠性直接构建于应用程序中可以使其“左右逢源” 。 也就是说应用进程可以进行可靠通信，而无需受制于由 TCP 拥塞控制机制而无需受制于传输速率限制。

### UDP报文段结构

![UDP报文结构](D:\Download\桌面\知识体系\图片\UDP报文结构.jpg)

> 长度指UDP报文段中的字节数（首部+数据），两个字节

+ UDP检验和

+ > 在既无法确保连链路的可靠性，又无法确保内存巾的差错检测的情况下，
  > 如果端到端数据传输服务要提供差错检测， UDP 就必须在端到端基础上在传输层提供差
  > 错检测 。 这是 一 个在系统设计巾被称颂的端到端原则（ end - end principle ）

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/d4c3a4a1-0846-46ec-9cc3-eaddfca71254.jpg" width="600"/> </div><br>

首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的。

### 伪首部 见图解TCP/IP
